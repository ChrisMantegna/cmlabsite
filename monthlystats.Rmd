---
Title: Monthly Stats for Project & Task Breakdown
---

```{r}
library(tidyverse)
library(yaml)
library(lubridate)

# Define the folder containing the blog posts
posts_folder <- "posts/"

# Read category groups from the CSV file
# Replace 'path/to/your/category_groups.csv' with the actual path to your CSV
category_groups <- read_csv('path/to/your/category_groups.csv')

# Read all posts and extract date and categories from YAML front matter
get_metadata <- function(file) {
  # Read the front matter of the post
  front_matter <- readLines(file) %>% 
    paste(collapse = "\n") %>% 
    yaml.load()
  
  # Return the date and categories as a data frame
  tibble(
    date = as.Date(front_matter$date),
    categories = front_matter$categories
  )
}

# List all the blog posts in the folder
post_files <- list.files(posts_folder, full.names = TRUE, pattern = "\\.qmd$")

# Extract metadata from all posts
post_metadata <- map_dfr(post_files, get_metadata)

# Create a 'month-year' column to group posts by month
post_metadata <- post_metadata %>%
  mutate(month_year = floor_date(date, "month"))

# Unnest the categories, so that each category is on its own row
category_usage <- post_metadata %>%
  unnest(categories)

# Join with category groups to assign each category to a group
category_usage <- category_usage %>%
  left_join(category_groups, by = "categories")

# Count the number of times each category tag is used within its group for each month
category_counts <- category_usage %>%
  group_by(month_year, group, categories) %>%
  summarise(count = n()) %>%
  ungroup()

# Calculate the total number of times tags within each group are used per month
total_group_counts_per_month <- category_usage %>%
  group_by(month_year, group) %>%
  summarise(total_group_count = n()) %>%
  ungroup()

# Join with category counts and calculate proportions of each tag within its group
category_proportions <- category_counts %>%
  left_join(total_group_counts_per_month, by = c("month_year", "group")) %>%
  mutate(proportion = count / total_group_count)

# Function to create pie charts for each group
create_pie_chart <- function(data, group_name) {
  ggplot(data, aes(x = "", y = proportion, fill = categories)) +
    geom_bar(stat = "identity", width = 1) +
    coord_polar("y") +
    labs(title = paste("Proportion of Tags in", group_name),
         fill = "Category") +
    theme_void() +
    theme(legend.position = "right") +
    scale_fill_brewer(palette = "Set3")
}

# Generate pie charts for each group
for (group_name in unique(category_proportions$group)) {
  # Filter data for the specific group
  group_data <- category_proportions %>% filter(group == group_name)
  
  # Create and save pie chart for the group
  pie_chart <- create_pie_chart(group_data, group_name)
  print(pie_chart)  # Display pie chart
}
```

```{r}

# save the monthly result if I want
ggsave(paste0(group_name, "_pie_chart.png"), plot = pie_chart)


```

