---
Title: Monthly Stats for Project & Task Breakdown
---


```{r}

getwd()

# Define the folder containing the blog posts
nbposts <- "/Users/cmantegna/Documents/cmlabsite/notebook/"

# Read category groups from the CSV file
# Replace 'path/to/your/category_groups.csv' with the actual path to your CSV
category_groups <- read.csv("/Users/cmantegna/Documents/cmlabsite/notebook_categories.csv")

```

```{r}
library(tidyverse)
library(yaml)
library(lubridate)
library(ggrepel)

# Read all posts and extract date and categories from YAML front matter
get_metadata <- function(file) {
  # Read the front matter of the post
  front_matter <- tryCatch({
    readLines(file) %>%
      paste(collapse = "\n") %>%
      yaml.load()
  }, error = function(e) {
    message(paste("Error reading file:", file))
    return(NULL)
  })
  
  # Check if the front matter was parsed correctly and contains necessary fields
  if (is.null(front_matter) || is.null(front_matter$date) || is.null(front_matter$categories)) {
    message(paste("Missing 'date' or 'categories' in file:", file))
    return(NULL)
  }
  
  # Return the date and categories as a data frame
  tibble(
    date = as.Date(front_matter$date),
    categories = front_matter$categories
  )
}

# List all the blog posts in the folder
post_files <- list.files(nbposts, full.names = TRUE, pattern = "\\.qmd$")

# Extract metadata from all posts, filtering out NULL results
post_metadata <- map_dfr(post_files, get_metadata, .id = "file") %>%
  filter(!is.null(date) & !is.null(categories))

# Filter for September posts only
post_metadata <- post_metadata %>%
  filter(month(date) == 9 & year(date) == 2024)  # Adjust to the correct year

# Create a 'month-year' column to group posts by month
post_metadata <- post_metadata %>%
  mutate(month_year = floor_date(date, "month"))

# Unnest the categories, so that each category is on its own row
category_usage <- post_metadata %>%
  unnest(categories)

# Join with category groups to assign each category to a group
category_usage <- category_usage %>%
  left_join(category_groups, by = "categories")

# Count the number of times each category tag is used within its group for each month
category_counts <- category_usage %>%
  group_by(month_year, group, categories) %>%
  summarise(count = n()) %>%
  ungroup()

# Function to create bar charts for each group
create_bar_chart <- function(data, group_name) {
  ggplot(data, aes(x = categories, y = count, fill = categories)) +
    geom_bar(stat = "identity") +
    geom_text(aes(label = count), vjust = -0.5) +  # Add count labels above bars
    labs(title = paste("Number of Entries in", group_name),
         x = "Category", y = "Count") +
    theme_minimal() +
    theme(legend.position = "none",  # Remove legend since it's redundant in bar charts
    axis.text.x = element_text(angle = 45, hjust = 1)) +
    scale_fill_brewer(palette = "Set3")  # Use a color palette
}

# Generate bar charts for each group and save them
for (group_name in unique(category_counts$group)) {
  # Filter data for the specific group
  group_data <- category_counts %>% filter(group == group_name)
  
  # Check if there is any data for this group before proceeding
  if (nrow(group_data) == 0) {
    message(paste("No data for group:", group_name))
    next  # Skip to the next group if no data is found
  }
  
  # Create the bar chart for the group
  bar_chart <- create_bar_chart(group_data, group_name)
  
  # Print the chart to display
  print(bar_chart)
  
  # Save the plot with the group name in the file name
  ggsave(
    filename = paste0("September_chart_", group_name, ".png"),  # Filename with group name
    plot = bar_chart,  # The plot to save
    width = 8, height = 6, units = "in",  # Adjust dimensions as needed
    dpi = 300  # Set the resolution
  )
}

# Create summary table of total count and breakdown by category
total_count <- sum(category_counts$count)

# Calculate the breakdown by category and group
summary_table <- category_counts %>%
  group_by(group, categories) %>%
  summarise(count = sum(count)) %>%
  ungroup() %>%
  arrange(group, desc(count))

# Add the total count to the summary table
summary_table <- summary_table %>%
  mutate(total = total_count)

# Filter the total_group_counts_per_month table for rows with NA group
na_group_counts <- total_group_counts_per_month %>%
  filter(is.na(group))

# Match those NA group entries with the category_usage table to inspect the categories
na_group_categories <- category_usage %>%
  filter(is.na(group))

# Display the result
na_group_categories %>%
  select(date, categories, group) %>%
  distinct()

```
